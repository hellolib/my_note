# ä¿¡å·(Signals)

- ä¿¡å·å¯ä»¥è®©æ‚¨åº”ç”¨ä¸­çš„ä¸åŒéƒ¨åˆ†å¯ä»¥ç›¸äº’é€šè®¯ã€‚

- ä¿¡å·åˆ†å‘åœ¨è§¦å‘æ—¶, æ‰€æœ‰ç¬¦åˆåŒ¹é…æ¡ä»¶çš„ä¿¡å·éƒ½ä¼šè¢«è§¦å‘

  ```python
  # æç«¯æ¡ä»¶ç¤ºä¾‹
  @content_bp.signal("apps.content.<action_name>")
  async def print_signal(action_name):
      print("----æˆ‘æ˜¯ä¿¡å·---1-")
      print(action_name)
  
  
  @content_bp.signal("apps.content.<action_name>")
  async def print_signal(action_name):
      print("----æˆ‘æ˜¯ä¿¡å·---2-")
      print(action_name)
  ```

  

## 1. æ·»åŠ ä¿¡å·

### 1.1 appæ·»åŠ 

```python
async def my_signal_handler():
    print("something happened")

app.add_signal(my_signal_handler, "something.happened.ohmy")

```

### 1.2 è£…é¥°å™¨æ·»åŠ 

```python
@app.signal("something.happened.ohmy")
async def my_signal_handler():
    print("something happened")

```

### 1.3 è“å›¾æ·»åŠ 

```python
bp = Blueprint("foo")

@bp.signal("something.happened.ohmy")
async def my_signal_handler():
    print("something happened")

```

## 2. äº‹ä»¶(Events)

- ä¿¡å·æ˜¯åŸºäºä¸€ä¸ª *äº‹ä»¶* çš„ã€‚ä¸€ä¸ªäº‹ä»¶ï¼Œå°±æ˜¯ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²ï¼Œå®ƒç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆå¦‚ä¸‹ï¼š

  ```python
  # namespace.reference.action
  demo1: my_app.something.happened
  demo2: sanic.notice.hello
  ```

### 2.1 äº‹ä»¶å‚æ•°(Event parameters)

- ä¸€ä¸ªäº‹ä»¶çš„åŠ¨ä½œå¯ä»¥æ˜¯â€œåŠ¨æ€çš„â€ï¼Œå…¶åŠ¨æ€çš„éƒ¨åˆ†ä½¿ç”¨ä¸ [è·¯ç”±å‚æ•°](https://sanicframework.org/zh/guide/basics/routing.html#path-parameters) ç›¸åŒçš„è¯­æ³•æ¥å£°æ˜ã€‚è¿™å…è®¸äº‹ä»¶æ ¹æ®ä»»æ„å€¼è¿›è¡ŒåŒ¹é…ã€‚

  ```python
  @app.signal("foo.bar.<thing>")
  async def signal_handler(thing):
      print(f"[signal_handler] {thing=}")
  
  @app.get("/")
  async def trigger(request):
      await app.dispatch("foo.bar.baz")
      return response.text("Done.")
  
  ```

  - åªæœ‰äº‹ä»¶çš„ç¬¬ä¸‰éƒ¨åˆ†ï¼ˆâ€œåŠ¨ä½œâ€éƒ¨åˆ†ï¼‰å¯ä»¥æ˜¯åŠ¨æ€çš„ï¼š
    - `foo.bar.<thing>` ğŸ†—
    - `foo.<bar>.baz` âŒ

### 2.2 ç­‰å¾…(Waiting)

- **ç­‰å¾…ä¸­çš„*ä¸é€‚ç”¨ä¿¡å·ä¸»åŠ¨è§¦å‘æ¡ä»¶**

- é™¤äº†ä¸»åŠ¨åˆ†å‘ä¿¡å·æ¥æ‰§è¡Œäº‹ä»¶çš„å“åº”å‡½æ•°ï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºè¿˜å¯ä»¥è¢«åŠ¨åœ°ç­‰å¾…äº‹ä»¶è¢«è§¦å‘ã€‚

  ```python
  await app.event("foo.bar.baz")
  ```

- **é‡è¦**ï¼šç­‰å¾…æ˜¯ä¸€ä¸ªé˜»å¡çš„åŠ¨ä½œã€‚å› æ­¤æ‚¨å¯èƒ½ä¼šæƒ³ä½¿ç”¨ [åå°ä»»åŠ¡](https://sanicframework.org/zh/guide/basics/tasks.html) æ¥å®ç°ç±»å‹çš„åŠŸèƒ½ã€‚

  ```python
  async def wait_for_event(app):
      while True:
          print("> waiting")
          await app.event("foo.bar.baz")
          print("> event found\n")
  
  @app.after_server_start
  async def after_server_start(app, loop):
      app.add_task(wait_for_event(app))
  ```

- ä½¿ç”¨ `*` ç¬¦å·æ¥åŒ¹é…ä»»æ„åŠ¨æ€äº‹ä»¶ã€‚

  ```python
  @app.signal("foo.bar.<thing>")
  
  ...
  
  await app.event("foo.bar.*")
  ```

  

## 3. åˆ†å‘(Dispatching)

- åˆ†å‘äº‹ä»¶åå°†ä¼šåšä¸¤ä»¶äº‹ä»¶ï¼š

  1. æ‰§è¡Œæ‰€æœ‰å’Œè¯¥äº‹ä»¶ç»‘å®šçš„å“åº”å‡½æ•°ã€‚
  2. è§¦å‘ä»»ä½•æ­£åœ¨â€œç­‰å¾…â€è¯¥äº‹ä»¶çš„å“åº”å‡½æ•°ã€‚

  ```python
  @app.signal("foo.bar.<thing>")
  async def foo_bar(thing):
      print(f"{thing=}")  #thing=baz
  
  await app.dispatch("foo.bar.baz")
  ```

  

### 3.1 ä¸Šä¸‹æ–‡(Context)

- æœ‰æ—¶æ‚¨ä¼šéœ€è¦å‘ä¿¡å·çš„å“åº”å‡½æ•°ä¸­ä¼ é€’é¢å¤–çš„ä¿¡æ¯ã€‚åœ¨ä¸Šé¢çš„ç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æ³¨å†Œçš„äº‹ä»¶ä¸­èƒ½å¤Ÿè·å–ç”¨æˆ·ä½¿ç”¨çš„ç”µå­é‚®ä»¶åœ°å€ã€‚

  ```python
  @app.signal("user.registration.created")
  async def send_registration_email(**context):
      print(context)  # {'hello': 'world'}
  
  await app.dispatch(
      "user.registration.created",
      context={"hello": "world"}
  )
  
  ```

  `ä¿¡å·æ˜¯åœ¨åå°ä»»åŠ¡ä¸­åˆ†å‘çš„ã€‚`

### 3.2 è“å›¾(Blueprints)

- åœ¨è“å›¾ä¸­åˆ†å‘ä¿¡å·çš„å·¥ä½œæœºåˆ¶ç±»ä¼¼äº [ä¸­é—´ä»¶](https://sanicframework.org/zh/guide/advanced/.../basics/middleware.html)ã€‚åœ¨åº”ç”¨å±‚é¢æ‰€åˆ†å‘çš„ä»»ä½•ä¿¡å·ï¼Œéƒ½ä¼šä¼ é€’åˆ°è“å›¾ä¸Šã€‚ä½†å¦‚æœåªåœ¨è“å›¾ä¸Šåˆ†å‘ï¼Œå°±åªä¼šæ‰§è¡Œåœ¨è¯¥è“å›¾ä¸Šå®šä¹‰çš„ä¿¡å·å“åº”å‡½æ•°ã€‚

- **Demo**

  - ```python
    bp = Blueprint("bp")
    
    app_counter = 0
    bp_counter = 0
    
    @app.signal("foo.bar.baz")
    def app_signal():
        nonlocal app_counter
        app_counter += 1
    
    @bp.signal("foo.bar.baz")
    def bp_signal():
        nonlocal bp_counter
        bp_counter += 1
    
    ```

  - è°ƒç”¨ `app.dispatch("foo.bar.baz")` å°†è§¦å‘ä¸¤ä¸ªä¿¡å·å“åº”å‡½æ•°ã€‚

    ```python
    await app.dispatch("foo.bar.baz")
    assert app_counter == 1
    assert bp_counter == 1
    
    ```

  - è°ƒç”¨ `bp.dispatch("foo.bar.baz")` å°†åªè§¦å‘ä¸€ä¸ªä¿¡å·å“åº”å‡½æ•°ã€‚

    ```python
    await bp.dispatch("foo.bar.baz")
    assert app_counter == 1
    assert bp_counter == 2
    ```

    

