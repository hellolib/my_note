## 自签证书说明

- 自签名证书指的是用户用自己的私钥对证书进行签名,而不是由权威的第三方证书颁发机构(CA)签发。
- 自签名证书没有被任何公认的CA签名认证,因此在大多数情况下会被浏览器、操作系统等视为不可信证书。
- 自签名证书主要用于内部测试、学习、临时使用等场景,而不是公开的互联网服务。
- 自签名证书的加密强度和权威CA签发的证书是一样的,关键取决于密钥长度和算法。

## 证书生成

- 示例生成5个证书文件

  - 根证书：root.crt
  - 服务器端公钥证书：server.crt
  - 服务器端私钥文件：server.key
  - 客户端公钥证书：client.crt
  - 客户端私钥文件：client.key

- 证书生成的内在逻辑示意图：

  ![](https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-02/0d709abe0eb95e0dacabd15cd2c0d4e7 (1).png)


### 1. 根证书生成

1. 创建根证书私钥：

   ```bash 
   openssl genrsa -out root.key 1024
   ```

2. 创建根证书请求文件：

   ``` bash 
   openssl req -new -out root.csr -key root.key
   
   # 后续参数请自行填写，下面是一个例子：
   Country Name (2 letter code) [XX]:cn
   State or Province Name (full name) []:bj
   Locality Name (eg, city) [Default City]:bj
   Organization Name (eg, company) [Default Company Ltd]:alibaba
   Organizational Unit Name (eg, section) []:test
   Common Name (eg, your name or your servers hostname) []:root
   Email Address []:a.alibaba.com
   A challenge password []:
   An optional company name []:
   ```

3. 创建根证书：

   ```bash 
   openssl x509 -req -in root.csr -out root.crt -signkey root.key -CAcreateserial -days 3650
   ```

### 2. 服务器端证书生成

1. 生成服务器端证书私钥：

   ```bash
   openssl genrsa -out server.key 1024
   ```

2. 生成服务器证书请求文件，过程和注意事项参考根证书

   ```bash
   openssl req -new -out server.csr -key server.key
   ```

3. 生成服务端公钥证书

   ```bash
   openssl x509 -req -in server.csr -out server.crt -signkey server.key -CA root.crt -CAkey root.key -CAcreateserial -days 3650
   
   ```

   

### 3. 客户端证书生成

1. 生成客户端证书秘钥：

   ```bash
   openssl genrsa -out client.key 1024
   ```


2. 生成客户端证书请求文件，过程和注意事项参考根证书

   ```bash
   openssl req -new -out client.csr -key client.key
   ```

3. 生客户端证书

   ```bash
   openssl x509 -req -in client.csr -out client.crt -signkey client.key -CA root.crt -CAkey root.key -CAcreateserial -days 3650
   ```
4. 生客户端p12格式证书，需要输入一个密码，选一个好记的，比如: 123456

   ```bash
   openssl pkcs12 -export -clcerts -in client.crt -inkey client.key -out client.p12
   ```



## 验签说明

- 验签是指验证数字签名的真实性和完整性的过程，能确保文件或数据在传输过程中未被篡改。
- 验签主要步骤：
  1. **获取签名公钥**：需要获取用于生成签名的公钥, 通常由签名者提供或存储在公开的密钥服务器中。
  2. **重新计算数据摘要**：使用与签名相同的哈希算法(如SHA-256)对原始数据重新计算摘要值。
  3. **验证签名**：使用签名验证算法(如RSA)和签名公钥,对签名值进行验证。验证过程通常包括解密签名值、比对解密后的摘要是否与重新计算的摘要相同。
  4. **结果判断**：如果验证成功,说明签名有效,数据未被篡改;如果验证失败,说明签名无效,数据有可能被窜改过。

## 对文件验签流程

> echo "test string" > test.txt

1. 生成签名密钥对

   ```bash
   openssl genpkey -algorithm RSA -out private_key.pem -aes256
   openssl rsa -pubout -in private_key.pem -out public_key.pem
   ```

2. 对文件 test.txt 文件签名

   ```bash
   openssl dgst -sha256 -sign private_key.pem -out signature.sign test.txt
   ```
3. 验证 test.txt 文件签名

   ```bash
   openssl dgst -sha256 -verify public_key.pem -signature signature.sign test.txt
   # Verified OK
   ```

