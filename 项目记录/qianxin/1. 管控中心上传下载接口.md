# 上传下载

## 功能

- 支持两种存储方式：
  1. 文件存储
  2. s3(minio)
  
- 两种存储方式可以通过配置文件切换，可以重启生效, 存储方式前端无感知（即接口相同)

- 支持认证上传，可以使用原来的接口认证方式。

- 支持http无认证下载

- 支持文件类型

  ```go
  // FileCategory 文件类型 图片 安装包 授权文件
  var FileCategory = []string{"image", "setup", "license"}
  
  // FileCategoryMap 文件类型 todo 逻辑优化
  var FileCategoryMap = map[string]string{
  
  	// 图片 bmp、jpg、jpeg、png、gif
  	"bmp":  FileCategory[0],
  	"jpg":  FileCategory[0],
  	"jpeg": FileCategory[0],
  	"png":  FileCategory[0],
  	"gif":  FileCategory[0],
  
  	// 安装包 exe msi rpm deb dmg
  	"exe": FileCategory[1],
  	"msi": FileCategory[1],
  	"rpm": FileCategory[1],
  	"deb": FileCategory[1],
  	"dmg": FileCategory[1],
  
  	// 授权文件
  	"lic":   FileCategory[2],
  	"qcert": FileCategory[2],
  }
  ```

  

## API

- browserconsole.api

  ```protobuf
  syntax = "proto3";
  
  package browserconsole.api;
  
  import "browserconsole-api/browserconsole/api/file_sys/file_sys.proto";
  import "google/protobuf/empty.proto";
  
  option go_package = "api";
  
  
  service FileSys{
  
    // 创建媒体文件
    rpc CreateFile(browserconsole.api.file_sys.CreateFile.Request)
        returns (browserconsole.api.file_sys.CreateFile.Response){}
  
    // 获取文件信息
    rpc GetFile(browserconsole.api.file_sys.GetFile.Request)
        returns (browserconsole.api.file_sys.GetFile.Response){}
  
    // 获取文件下载链接
    rpc GetDownloadUrl(browserconsole.api.file_sys.GetDownloadUrl.Request)
        returns (browserconsole.api.file_sys.GetDownloadUrl.Response){}
  
    // 文件状态更新
    rpc UploadFileCallBack (browserconsole.api.file_sys.UploadFileCallBack.Request)
        returns (google.protobuf.Empty){}
  
    // 文件删除
    rpc DeleteFile (browserconsole.api.file_sys.DeleteFile.Request)
        returns (google.protobuf.Empty){}
    
    // 文件重命名
    rpc RenameFile (browserconsole.api.file_sys.RenameFile.Request)
        returns (google.protobuf.Empty){}
  
    // 文件通过url删除
    rpc DeleteFileWithUrl (browserconsole.api.file_sys.DeleteFileWithUrl.Request)
        returns (google.protobuf.Empty){}
  
  }
  
  ```

- browserconsole.api.file_sys

  ```protobuf
  syntax = "proto3";
  
  package browserconsole.api.file_sys;
  
  import "browserconsole-api/browserconsole/file_sys/file_sys.proto";
  
  option go_package = "filesysapi";
  
  // 文件创建
  message CreateFile {
    message Request {
      browserconsole.file_sys.CreateFileInfo file_info = 1;
    }
    message Response {
      uint64 id = 1;
      // 文件 上传链接
      string upload_url = 2;
    }
  }
  
  // 文件获取
  message GetFile {
    message Request {
      uint64 id = 1;
    }
    message Response {
      browserconsole.file_sys.FileInfo file_info = 1;
    }
  }
  
  // 文件下载链接获取
  message GetDownloadUrl {
    message Request {
      uint64 id = 1;
    }
    message Response {
      string download_url = 1;
    }
  }
  
  // 文件状态更新
  message UploadFileCallBack{
    message Request {
      uint64 id = 1;
      browserconsole.file_sys.UploadState state = 2;
    }
  }
  
  
  // 文件删除接口
  message DeleteFile{
    message Request {
      uint64 id = 1;
    }
  }
  
  
  // 文件改名接口
  message RenameFile{
    message Request {
      uint64 id = 1;
      string new_name = 2;
    }
  }
  
  // 文件通过url删除接口
  message DeleteFileWithUrl{
    message Request {
      string url = 1;
    }
  }
  
  
  
  ```

- browserconsole.file_sys

  ```protobuf
  syntax = "proto3";
  
  package browserconsole.file_sys;
  
  option go_package = "filesys";
  
  // 文件上传状态
  enum UploadState {
    CREATED = 0;
    UPLOADING = 1;
    // 成功
    UPLOADED = 2;
    // 失败
    FAILED = 3;
  }
  
  // 创建媒体文件
  message CreateFileInfo {
    string file_name = 1;
    uint64 file_size = 2;
    string file_hash = 3;
  }
  
  // 文件元数据信息
  message FileInfo {
    string file_name = 1;
    string file_type = 2;
    uint64 file_size = 3;
    string file_hash = 4;
    UploadState upload_state = 5;
    int64 upload_expire = 6;
    string Bucket = 7;
    string file_download_url = 8;
    string upload_url = 9;
    string UploadId = 10;
    int64 created = 11;
    int64 updated = 12;
  }
  ```

## 调用说明

### 1. CreateFile

- 首先需要调用CreateFile接口，返回文件上传链接
- **通过put请求上传文件**

### 2. UploadFileCallBack

- **上传完成后**，需要手动调用回调函数修改上传状态
- 上传状态码：
  - 0 创建（默认）
  - 1 上传中 （没有实际意义）
  - 2 成功 
  - 3 失败
- 当回调接口传参是2时，接口会真实生成数据文件，并在数据库更新数据下载链接

### 3. GetDownloadUrl

- 获取下载链接

### 4. DeleteFile

- 通过文件id删除文件

### 5. DeleteFileWithUrl

- 通过下载链接删除文件

### 6. GetFile

- 获取文件信息

### 7. RenameFile

- 文件重新命名



调用顺序: CreateFile -> 通过put请求上传链接上传文件 ->  UploadFileCallBack -> ...
